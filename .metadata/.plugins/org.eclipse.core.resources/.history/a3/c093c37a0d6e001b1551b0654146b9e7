/*
 * generated by Xtext 2.14.0
 */
package polytech.spaceteam.cineditor.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.AbstractGenerator
import org.eclipse.xtext.generator.IFileSystemAccess2
import org.eclipse.xtext.generator.IGeneratorContext
import java.util.ArrayList
import javax.inject.Inject
import org.eclipse.xtext.naming.IQualifiedNameProvider
import CinEditorML.Movie
import java.util.List
import CinEditorML.Layer
import CinEditorML.Element
import CinEditorML.Text
import CinEditorML.GraphicalElement
import CinEditorML.Picture
import CinEditorML.Video
import CinEditorML.FadeOut
import CinEditorML.FadeIn
import CinEditorML.Translate
import CinEditorML.Effect
import CinEditorML.ItemPositionInt
import CinEditorML.ItemPosition
import CinEditorML.ItemPositionString
import CinEditorML.Shape
import CinEditorML.Rectangle
import java.awt.Color
import CinEditorML.AudioElement

/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
class CinEditorGenerator extends AbstractGenerator {

	val varMovieHeight = "movie_height";
	val varMovieWidth = "movie_width";
	val elementsVarNames = new ArrayList();
	val totalMovieDuration = 23;
	
	@Inject extension IQualifiedNameProvider
	
	override void doGenerate(Resource resource, IFileSystemAccess2 fsa, IGeneratorContext context) {
		elementsVarNames.clear();
		for (movie : resource.allContents.toIterable.filter(Movie)) {
			val _fullyQualifiedName = this._iQualifiedNameProvider.getFullyQualifiedName(movie);
			fsa.generateFile(
            	_fullyQualifiedName + ".py",
            	compile(movie))
		}
	
	}
	
	private def String compile(Movie movie) {
		var movieString = loadImports();
		movieString += extractMovieSize(movie);
		movieString += extractLayers(movie.getLayers());
		movieString += extractFinalCut(movie);
		return movieString;
	}
	
	private def String extractFinalCut(Movie movie) {
		var sFinal = "\nvideo = CompositeVideoClip([";
		for (var i = 0; i < elementsVarNames.size(); i++) {
			if (i != 0) {
				sFinal += ", ";
			}
			sFinal += elementsVarNames.get(i);
		}
		sFinal += "], size=(" + varMovieWidth + "," + varMovieHeight + ")).set_duration(" + totalMovieDuration + ")\n"; //TODO when no video set a calculated duration
		sFinal += "video.write_videofile('./" + movie.getName()  + ".mp4', codec='mpeg4', bitrate='8000k', fps=" + movie.getFps() +")";
		return sFinal;
	}
	
	private def String extractLayers(List<Layer> layers) {
		var s = "";
		for (Layer layer : layers) {
			s += extractElementsFromLayer(layer.getElements());
		}
		return s;
	}
	
	private def String extractElementInLayer(Element element) {
		var s = "";
		if (element instanceof Text) {
			s += extractElement(element as Text);
		 } else if (element instanceof Picture) {
			s += extractElement(element as Picture);
		} else if (element instanceof Video) {
			s += extractElement(element as Video);
		} else if (element instanceof Effect) {
			s += extractElement(element as Effect);
		} else if (element instanceof Shape) {
			s += extractElement(element as Shape);
		} else if (element instanceof AudioElement) {
			s += extractElement(element as AudioElement);
		}
		return s;
	}
	
	private def String extractBeginTimeFromElement(Element element) {
		var s = "";
		if (element.getBeginTime() > 0) {
			s += "\\\n\t.set_start(" + element.getBeginTime() + ")";
		}
		return s;
	}
	
	private def String extractDurationFromElement(Element element) {
		var s = "";
		var duration = -1;
		if (element.duration > 0) {
			duration = element.duration;
		} else if (element instanceof AudioElement) {
			duration = (element as AudioElement).element.duration;
			if (duration < 0) { // in case the element.duration is during the whole film
				duration = totalMovieDuration;
			}
		} else if (!(element instanceof Video)) {
			duration = totalMovieDuration;
		}
		if (duration != -1) {
			s += "\\\n\t.set_duration(" + duration + ")";
		}
		return s;
	}
	
	private def String extractDimensionFromElement(GraphicalElement element) {
		var s = "";
		var width = "0"
			var height = "0"
		if (element.dimension !== null) {
			if (element.dimension.width < 0) {
				width = varMovieWidth;
			} else {
				width = element.dimension.width + "";
			}
			if (element.dimension.height < 0) {
				height = varMovieWidth;
			} else {
				height = element.dimension.height + "";
			}
		} else {
			width = varMovieWidth;
			height = varMovieWidth;
		}
		if (element instanceof Shape) {
			s += "(" + width + ", " + height + ")";
		} else {
			s += "\\\n\t.resize((" + width + ", " + height + "))";
		}
		return s;
	}
	
	private def String extractPositionFromElement(GraphicalElement element) {
		var s = "";
		var posX = "";
		var posY = "";
		if (element.position !== null) {
			posX = extractValueFromItemPosition(element.position.x);
			posY = extractValueFromItemPosition(element.position.y);
		} else {
			posX = "0";
			posY = "0";
		}

		if (!posX.equals("0") || !posY.equals("0")) {
			s += "\\\n\t.set_pos((" + posX + ", " + posY + "))";
		}
		return s;
	}
	
	private def String extractValueFromItemPosition(ItemPosition item) {
		if (item instanceof ItemPositionInt) {
			return (item as ItemPositionInt).position + "";
		}
		return "'" + (item as ItemPositionString).position + "'";
	}
		
	private def String extractElement(Text element) {		
		var s = element.getName() 
				+ " = TextClip("
					+ "\"" +element.getText() + "\""
					+ ", color='#" + element.getColor().getHexadecimalValue() + "'"
					+ ", fontsize=" + element.getFontSize()
				+ ")"
				+ extractBeginTimeFromElement(element)
				+ extractDurationFromElement(element)
				+ extractPositionFromElement(element)
				+ "\n\n";
		elementsVarNames.add(element.getName());
		return s;
	}
	
	private def String extractElement(Picture element) {
		var s = element.getName() 
				+ " = ImageClip("
					+ "\"" +element.url + "\""
				+ ")"
				+ extractBeginTimeFromElement(element)
				+ extractDurationFromElement(element)
				+ extractPositionFromElement(element)
				+ extractDimensionFromElement(element)
				+ "\n\n";
		elementsVarNames.add(element.getName());
		return s;
	}
	
	private def String extractElement(AudioElement element) {
		var volume = "";
		var fadeIn = "";
		var fadeOut = "";
		var cropString = "";
		if (element.volume != 1) {
			volume = "\\\n\t.volumex(" + element.volume + ")";
		}
		if (element.fadeIn != 0) {
			fadeIn = "\\\n\t.audio_fadein(" + element.fadeIn + ")";
		}
		if (element.fadeOut != 0) {
			fadeOut = "\\\n\t.audio_fadeout(" + element.fadeOut + ")";
		}
		if (element.beginCropTime > -1) {
			cropString = "\\\n\t.subclip(" + element.beginCropTime + ", " + (element.beginCropTime + element.duration) + ")";
		}
		
		var s = element.getName() 
				+ " = AudioFileClip(" + "\"" +element.url + "\"" + ")"
					+ extractBeginTimeFromElement(element)
					+ extractDurationFromElement(element)
					+ cropString
					+ volume
					+ fadeIn
					+ fadeOut
					+ "\n";
		s += element.element.name + " = " + element.element.name + ".set_audio(" + element.getName() + ")\n\n";
		return s;
	}
	
	private def String extractElement(Video element) {
		var cropString = ""
		if (element.beginCropTime > -1) {
			cropString = "\\\n\t.subclip(" + element.beginCropTime + ", " + (element.beginCropTime + element.duration) + ")";
		}
		var audio = "";
		if (element.enableAudio == true) {
			audio = "True";
		} else {
			audio = "False";
		}
		var s = element.getName() 
				+ " = VideoFileClip(" + "\"" +element.url + "\"" + ", audio=" + audio +")"
					+ extractBeginTimeFromElement(element)
					+ extractDurationFromElement(element)
					+ extractDimensionFromElement(element)
					+ cropString
					+ "\n\n";
		elementsVarNames.add(element.getName());
		return s;
	}
	
	private def String extractElement(FadeIn element) {
		var s = "";
		
		return s;
	}
	
	private def String extractElement(FadeOut element) {
		var s = "";
		
		return s;
	}
	
	private def String extractElement(Translate element) {
		var s = "";
		
		return s;
	}
	
	
	private def String extractElement(Rectangle element) {
		var color = "[0,0,0]"; // need rgb color for color clip
		if (element.color !== null) {
			val tmp = Color.decode("#" + element.color.hexadecimalValue);
			color = "[" + tmp.red + "," + tmp.green + "," + tmp.blue + "]";
		}
		var s = element.getName() 
				+ " = ColorClip(size=" + extractDimensionFromElement(element) + ", col=" + color + ")"
				+ extractBeginTimeFromElement(element)
				+ extractDurationFromElement(element)
				+ extractPositionFromElement(element)
				+ "\n\n";
		elementsVarNames.add(element.getName());
		return s;
	}
	
	private def String extractElement(Effect element) {
		var s = "";
		if (element instanceof FadeIn) {
			s += extractElement(element as FadeIn);
		} else if (element instanceof FadeOut) {
			s += extractElement(element as FadeOut);
		} else if (element instanceof Translate) {
			s += extractElement(element as Translate);
		} 
		return s;
	}
	
	private def String extractElement(Shape element) {
		var s = "";
		if (element instanceof Rectangle) {
			s += extractElement(element as Rectangle);
		}
		return s;
	}
	
	private def String extractElementsFromLayer(List<Element> elements) {
		var s = "";
		for (Element element : elements) {
			s += extractElementInLayer(element);
		}
 		return s;
	}

	private def String extractMovieSize(Movie movie) {
		var s = varMovieHeight + " = " + movie.getDimension().getHeight() + "\n";
		s += varMovieWidth + " = " + movie.getDimension().getWidth() + "\n";
		s += "\n";
		return s;
	}
	
	private def String loadImports() {
		var s = "from moviepy.editor import *\n";
		s += "\n";
		return s;
	}
}
